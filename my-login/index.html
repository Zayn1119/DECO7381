<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>

<!-- 
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <div id="probe" style="position:fixed;left:10px;bottom:10px;padding:8px 10px;border-radius:6px;background:#eee;font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, monospace;box-shadow:0 2px 8px rgba(0,0,0,.1);z-index:9999">Probing…</div>

    <div style="position:fixed;right:10px;bottom:10px;display:flex;flex-direction:column;gap:10px;z-index:9999">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnListA">List Attendees</button>
        <button id="btnCreateA">Create Sample Attendee</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnListS">List Sessions</button>
        <button id="btnCreateS">Create Demo Session</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnListRooms">List Rooms</button>
        <button id="btnListSeats">List Seats</button>
        <button id="btnCreateAssign">Create Seat Assignment</button>
        <button id="btnListAssign">List Seat Assignments</button>
      </div>
    </div>

    <script type="module">
      // 全局错误兜底：任何异常都会弹窗
      window.addEventListener('error', e => alert('JS Error: ' + e.message));
      window.addEventListener('unhandledrejection', e => alert('Promise Error: ' + (e.reason?.message || e.reason)));

      const probe = document.getElementById('probe');
      const API   = (import.meta.env && import.meta.env.VITE_API_BASE) || 'http://127.0.0.1:8000';

      async function j(url, opts) {
        const r = await fetch(url, opts);
        const text = await r.text();
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}: ${text}`);
        return text ? JSON.parse(text) : null;
      }
      async function refreshAttendeeCount() {
        try {
          const d = await j(`${API}/api/attendees/`);
          probe.textContent = `API OK ✓  attendees.length = ${Array.isArray(d)? d.length : 'N/A'}  (${API})`;
          return d;
        } catch (e) {
          probe.textContent = `API ERROR ✗  ${e.message}`;
          throw e;
        }
      }
      refreshAttendeeCount();

      // —— Attendees
      document.getElementById('btnListA').onclick   = async () => { const d = await refreshAttendeeCount(); console.log('[Attendees]', d); alert(`Attendees: ${d.length}`); };
      document.getElementById('btnCreateA').onclick = async () => {
        const d = await j(`${API}/api/attendees/`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ full_name:`Alice-${Math.floor(Math.random()*10000)}` }) });
        alert(`Created attendee id=${d.id}`); await refreshAttendeeCount();
      };

      // —— Sessions（需要 Room、start_time、end_time）
      document.getElementById('btnListS').onclick   = async () => { const d = await j(`${API}/api/sessions/`); console.log('[Sessions]', d); alert(`Sessions: ${d.length}`); };
      document.getElementById('btnCreateS').onclick = async () => {
        const rooms = await j(`${API}/api/rooms/`);
        if (!rooms.length) { alert('没有 Room：请先到 Django Admin → Conference → Rooms 新建一个'); return; }
        const roomId = rooms[0].id;
        const start = new Date(Date.now()+5*60*1000).toISOString();
        const end   = new Date(Date.now()+65*60*1000).toISOString();
        const payload = { title:`Demo ${new Date().toLocaleTimeString()}`, code:`DEMO-${Math.floor(Math.random()*10000)}`, start_time:start, end_time:end, room:roomId };
        const d = await j(`${API}/api/sessions/`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        alert(`Created session id=${d.id} code=${d.code}`);
      };

      // —— Rooms / Seats
      document.getElementById('btnListRooms').onclick = async () => { const d = await j(`${API}/api/rooms/`); console.log('[Rooms]', d); alert(`Rooms: ${d.length}`); };
      document.getElementById('btnListSeats').onclick = async () => { const d = await j(`${API}/api/seats/`); console.log('[Seats]', d); alert(`Seats: ${d.length}`); };

      // —— Seat Assignments（自动适配 seat 或 seat_label）
      async function createAssignment(sessionId, attendeeId, seatObj) {
        // 先尝试 seat 外键
        try {
          return await j(`${API}/api/seat-assignments/`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ session:sessionId, attendee:attendeeId, seat:seatObj.id, status:'assigned' })
          });
        } catch (e) {
          const msg = e.message || '';
          // 如果后端需要 seat_label，再用 label 重试
          if (msg.includes('seat_label')) {
            const label = seatObj.seat_label || seatObj.label || seatObj.name || seatObj.code || `S-${seatObj.id}`;
            return await j(`${API}/api/seat-assignments/`, {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ session:sessionId, attendee:attendeeId, seat_label:label, status:'assigned' })
            });
          }
          throw e;
        }
      }

      document.getElementById('btnCreateAssign').onclick = async () => {
        try {
          // 1) 拿一个 attendee（没有就自动创建）
          let attendees = await j(`${API}/api/attendees/`);
          if (!attendees.length) {
            attendees = [ await j(`${API}/api/attendees/`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ full_name:`Alice-${Math.floor(Math.random()*10000)}` }) }) ];
          }
          const attendee = attendees[0];

          // 2) 拿一个 session（没有就自动创建）
          let sessions = await j(`${API}/api/sessions/`);
          if (!sessions.length) {
            const rooms = await j(`${API}/api/rooms/`);
            if (!rooms.length) { alert('没有 Room：请先到 Admin 新建 Room'); return; }
            const roomId = rooms[0].id;
            const start = new Date(Date.now()+5*60*1000).toISOString();
            const end   = new Date(Date.now()+65*60*1000).toISOString();
            sessions = [ await j(`${API}/api/sessions/`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ title:'Auto Session', code:`AUTO-${Math.floor(Math.random()*10000)}`, start_time:start, end_time:end, room:roomId }) }) ];
          }
          const session = sessions[sessions.length-1];

          // 3) 拿一把 seat（优先同房间）
          const seats = await j(`${API}/api/seats/`);
          if (!seats.length) { alert('没有 Seat：请到 Admin 新建 Seats（挂在某个 Room 下）'); return; }
          const roomId = session.room ?? session.room_id;
          const seat   = seats.find(s => (s.room ?? s.room_id) === roomId) || seats[0];

          // 4) 创建分配（自适配 seat / seat_label）
          const d = await createAssignment(session.id, attendee.id, seat);
          alert(`Assigned ✓  id=${d.id}  (session=${session.id}, attendee=${attendee.id}, seat=${seat.id || seat.seat_label})`);
        } catch (e) {
          alert('Create assignment failed: ' + (e.message || e));
          console.error(e);
        }
      };

      document.getElementById('btnListAssign').onclick = async () => {
        const d = await j(`${API}/api/seat-assignments/`);
        console.log('[SeatAssignments]', d);
        alert(`SeatAssignments: ${Array.isArray(d)? d.length : 'N/A'}`);
      };
    </script>
  </body>
</html>
 -->
